version: 0.2

env:
  variables:
    BUCKET_NAME: "threadcast-web-prod"
    DISTRIBUTION_ID: "E3OX16498YHUTR"
    VITE_API_URL: "https://api.threadcast.io/api"
    VITE_WS_URL: "wss://api.threadcast.io/ws"

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "Installing frontend dependencies..."
      - cd threadcast-web
      - npm ci

  build:
    commands:
      - echo "Building React application..."
      - npm run build
      - echo "Build complete."

  post_build:
    commands:
      - echo "Deploying to S3..."
      # Sync all assets with long cache (hashed filenames)
      - aws s3 sync dist/ s3://$BUCKET_NAME/ --delete --cache-control "public, max-age=31536000" --exclude "index.html"
      # Upload index.html with no-cache
      - aws s3 cp dist/index.html s3://$BUCKET_NAME/index.html --cache-control "no-cache, no-store, must-revalidate" --content-type "text/html"
      # Invalidate CloudFront
      - echo "Invalidating CloudFront cache..."
      - aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
      - echo "Frontend deployment complete."

cache:
  paths:
    - 'threadcast-web/node_modules/**/*'

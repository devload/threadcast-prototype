version: 0.2

env:
  variables:
    ARTIFACTS_BUCKET: "threadcast-build-artifacts"
    INSTANCE_ID: "i-050aae922dcfdc450"
    REGION: "ap-northeast-2"

phases:
  install:
    runtime-versions:
      java: corretto17
    commands:
      - echo "Downloading sessioncast JARs from S3 to local Maven repo..."
      - aws s3 cp s3://$ARTIFACTS_BUCKET/maven/ ~/.m2/repository/ --recursive
      - echo "SessionCast JARs installed to local Maven repository."

  build:
    commands:
      - echo "Building Spring Boot application..."
      - cd threadcast-server
      - chmod +x gradlew
      - ./gradlew clean bootJar -x test
      - echo "Build complete."

  post_build:
    commands:
      - echo "Uploading JAR to S3..."
      - aws s3 cp build/libs/threadcast-server-0.0.1-SNAPSHOT.jar s3://$ARTIFACTS_BUCKET/deploy/threadcast-server.jar

      - echo "Deploying to EC2 via SSM..."
      - |
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$INSTANCE_ID" \
          --document-name "AWS-RunShellScript" \
          --parameters '{"commands":[
            "set -e",
            "cd /home/ec2-user/threadcast",
            "sudo systemctl stop threadcast || true",
            "[ -f threadcast-server.jar ] && cp threadcast-server.jar threadcast-server.jar.backup",
            "aws s3 cp s3://threadcast-build-artifacts/deploy/threadcast-server.jar .",
            "sudo systemctl start threadcast",
            "echo Waiting for application to start...",
            "sleep 15",
            "curl -sf http://localhost:8080/api/health && echo Health check passed || echo Health check failed"
          ]}' \
          --region "$REGION" \
          --output text \
          --query 'Command.CommandId')

      - echo "SSM Command ID = $COMMAND_ID"

      # Wait for SSM command to complete
      - |
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$INSTANCE_ID" \
          --region "$REGION" || true

      - |
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$INSTANCE_ID" \
          --region "$REGION" \
          --query '[Status, StandardOutputContent, StandardErrorContent]' \
          --output text

      - echo "Backend deployment complete."

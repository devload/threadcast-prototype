# ============================================================================
# ThreadCast Server Configuration
# ============================================================================
# Profiles:
#   - local: 로컬 개발 (PostgreSQL Docker, port 21000, Mock OAuth)
#   - prod:  프로덕션 (AWS RDS, port 8080, SessionCast OAuth)
#   - dev:   빠른 테스트 (H2 인메모리, port 21000)
#   - demo:  데모용 (H2 + 샘플 데이터)
# ============================================================================

spring:
  application:
    name: threadcast-server

  profiles:
    active: local

  jpa:
    open-in-view: false
    properties:
      hibernate:
        format_sql: true
        default_batch_fetch_size: 100

# Default server port (overridden by prod profile)
server:
  port: 21000

# Actuator endpoints
management:
  endpoints:
    web:
      base-path: /api
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: when-authorized

# JWT Configuration (overridden by prod profile)
jwt:
  secret: threadcast-secret-key-for-jwt-token-generation-must-be-at-least-256-bits-long
  access-token-expiration: 86400000   # 24 hours
  refresh-token-expiration: 604800000 # 7 days

# SessionCast Relay Configuration (shared)
sessioncast:
  relay:
    url: wss://relay.sessioncast.io/ws
    token: ${SESSIONCAST_TOKEN:dev@localhost}
  agent:
    machine-id: threadcast-server
    label: ThreadCast Server
    auto-connect: false
    auto-stream-on-create: true

# ThreadCast Hub (overridden by prod profile)
threadcast:
  hub:
    auto-start: true

# JIRA Integration Configuration
jira:
  cloud:
    client-id: ${JIRA_CLOUD_CLIENT_ID:}
    client-secret: ${JIRA_CLOUD_CLIENT_SECRET:}
    redirect-uri: ${JIRA_REDIRECT_URI:http://localhost:21002/integrations/jira/callback}
    scopes: read:jira-work read:jira-user write:jira-work offline_access
  encryption:
    key: ${JIRA_ENCRYPTION_KEY:threadcast-jira-key-32-bytes!!}

# Sentry Configuration
sentry:
  dsn: ${SENTRY_DSN:https://17d7e7431fa6cf55fc85f21148be7d7a@o4510832077701120.ingest.us.sentry.io/4510832153067520}
  traces-sample-rate: 1.0
  environment: ${SENTRY_ENV:local}
  send-default-pii: false

# Default Logging
logging:
  level:
    io.threadcast: DEBUG
    org.springframework.web: INFO
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG

# ============================================================================
# LOCAL Profile - 로컬 개발 환경
# ============================================================================
# - PostgreSQL: Docker (localhost:5432)
# - Port: 21000
# - OAuth: Mock Server (localhost:22081)
# - Hub: Auto-start enabled (tmux 필요)
#
# 실행: ./gradlew bootRun (또는 SPRING_PROFILES_ACTIVE=local)
# 필요: docker-compose up -d (PostgreSQL)
# ============================================================================
---
spring:
  config:
    activate:
      on-profile: local

  datasource:
    url: jdbc:postgresql://localhost:5432/threadcast
    driver-class-name: org.postgresql.Driver
    username: threadcast
    password: threadcast123
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect

# Local Mock OAuth Server
sessioncast:
  oauth:
    auth-url: http://localhost:22081
    client-id: threadcast
    redirect-uri: http://localhost:21002/auth/callback

# ============================================================================
# PROD Profile - 프로덕션 환경 (AWS)
# ============================================================================
# - PostgreSQL: AWS RDS
# - Port: 8080
# - OAuth: SessionCast Production (auth.sessioncast.io)
# - Hub: Disabled (tmux 없음)
#
# 필수 환경변수:
#   - DB_HOST, DB_PORT, DB_NAME, DB_USERNAME, DB_PASSWORD
#   - JWT_SECRET
#   - SPRING_PROFILES_ACTIVE=prod
# ============================================================================
---
spring:
  config:
    activate:
      on-profile: prod

  datasource:
    url: jdbc:postgresql://${DB_HOST}:${DB_PORT:5432}/${DB_NAME:threadcast}
    driver-class-name: org.postgresql.Driver
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000

  h2:
    console:
      enabled: false

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect

server:
  port: 8080

jwt:
  secret: ${JWT_SECRET}

# Production OAuth - SessionCast
sessioncast:
  oauth:
    auth-url: https://auth.sessioncast.io
    client-id: threadcast
    redirect-uri: https://threadcast.io/auth/callback

# Disable Hub (no tmux on EC2)
threadcast:
  hub:
    auto-start: false
  callback:
    host: api.threadcast.io
    scheme: https
    port: 443

logging:
  level:
    io.threadcast: INFO
    org.springframework.web: WARN
    org.springframework.security: WARN
    org.hibernate.SQL: WARN

# ============================================================================
# DEV Profile - 빠른 테스트용 (H2 인메모리)
# ============================================================================
# - H2: 인메모리 (서버 재시작 시 초기화)
# - Port: 21000
# - H2 Console: http://localhost:21000/h2-console
#
# 실행: SPRING_PROFILES_ACTIVE=dev ./gradlew bootRun
# ============================================================================
---
spring:
  config:
    activate:
      on-profile: dev

  datasource:
    url: jdbc:h2:mem:threadcast;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password:

  h2:
    console:
      enabled: true
      path: /h2-console

  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true

# ============================================================================
# DEMO Profile - 데모/프레젠테이션용
# ============================================================================
# - H2: 인메모리 + 샘플 데이터 (DevDataInitializer)
# - Port: 21000
#
# 실행: SPRING_PROFILES_ACTIVE=demo ./gradlew bootRun
# ============================================================================
---
spring:
  config:
    activate:
      on-profile: demo

  datasource:
    url: jdbc:h2:mem:threadcast-demo;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password:

  h2:
    console:
      enabled: true
      path: /h2-console

  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: false

logging:
  level:
    io.threadcast: INFO
    org.springframework.web: INFO
    org.springframework.security: INFO
    org.hibernate.SQL: WARN

demo:
  user:
    email: demo@threadcast.io
    password: demo1234
    name: Demo User

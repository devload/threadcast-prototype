name: Deploy Backend

on:
  push:
    branches: [release]
    paths:
      - 'threadcast-server/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  EC2_HOST: 3.39.185.18
  EC2_USER: ec2-user
  REMOTE_DIR: /home/ec2-user/threadcast

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x threadcast-server/gradlew

      - name: Build with Gradle
        working-directory: threadcast-server
        run: ./gradlew clean bootJar -x test

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/threadcast-key.pem
          chmod 600 ~/.ssh/threadcast-key.pem
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Upload JAR to EC2
        run: |
          scp -i ~/.ssh/threadcast-key.pem \
            threadcast-server/build/libs/threadcast-server-0.0.1-SNAPSHOT.jar \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.REMOTE_DIR }}/threadcast-server.jar.new

      - name: Upload configuration
        run: |
          scp -i ~/.ssh/threadcast-key.pem \
            deploy/ec2/application-prod.yml \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.REMOTE_DIR }}/

      - name: Deploy and restart service
        run: |
          ssh -i ~/.ssh/threadcast-key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
          set -e
          cd /home/ec2-user/threadcast

          # Stop the service
          sudo systemctl stop threadcast || true

          # Backup and replace JAR
          if [ -f threadcast-server.jar ]; then
            mv threadcast-server.jar threadcast-server.jar.backup
          fi
          mv threadcast-server.jar.new threadcast-server.jar

          # Start the service
          sudo systemctl start threadcast

          # Wait for startup
          sleep 15

          # Health check
          curl -sf http://localhost:8080/api/health || exit 1

          echo "Deployment successful!"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/threadcast-key.pem
